varnishtest "valid session cookie passes through and sets claim header"

server s_oidc -listen "127.0.0.1:18087" {
    rxreq
    expect req.url == "/.well-known/openid-configuration"
    txresp -status 200 -hdr "Content-Type: application/json" -body {
        {
            "issuer": "http://localhost",
            "authorization_endpoint": "http://127.0.0.1:18087/authorize",
            "token_endpoint": "http://127.0.0.1:18087/token",
            "jwks_uri": "http://127.0.0.1:18087/jwks"
        }
    }

    rxreq
    expect req.url == "/jwks"
    txresp -status 200 -hdr "Content-Type: application/json" -body {
        {
            "keys":[
                {"kty":"RSA","alg":"RS256","kid":"test-key","n":"AQAB","e":"AQAB"}
            ]
        }
    }
} -start

server s_app {
    rxreq
    expect req.url == "/protected/resource"
    expect req.http.X-User-Email == "user@example.com"
    txresp -status 200 -body "ok"
} -start

varnish v1 -vcl+backend {
    import oidc from "${vmod}";

    sub vcl_init {
        new p = oidc.provider(
            discovery_url = "http://127.0.0.1:18087/.well-known/openid-configuration",
            client_id = "client-123",
            client_secret = "secret-xyz",
            redirect_uri = "http://127.0.0.1:8080/oidc/callback",
            cookie_secret = "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef",
            cookie_secure = false
        );
    }

    sub vcl_recv {
        set req.backend_hint = s_app;
        if (req.url ~ "^/protected/") {
            if (!p.session_valid()) {
                return (synth(302, "Login required"));
            }
            set req.http.X-User-Email = p.claim("email");
        }
    }

    sub vcl_synth {
        if (resp.status == 302 && resp.reason == "Login required") {
            set resp.http.Location = p.authorization_url();
            return (deliver);
        }
    }
} -start

client c1 {
    txreq -url "/protected/resource" -hdr "Cookie: __oidc=v1.AAECAwQFBgcICQoL-ib7aGLFGCr5p6B2GcuP8Xr_NpL5lUd8wbal93-mCmQxi-weF9Wf8X5vpdMwPnvEZz5eiFdgk43ZCisUch96-BalU_oM1UBlr0tYK6ebD-HuMAjpHtgjEoOT2QkBnX63OzQB15TiX-sCv3fH5ur5-J4VL8XeF9LCJe2_SVoHFkzXqV8ju368_P8f0Qcfx9HhzS4idAbcguaBF7eDi_9yNrJopQwZxlJZSTjDuORd2u1pcA0m"
    rxresp
    expect resp.status == 200
    expect resp.http.Location == <undef>
    expect resp.body == "ok"
} -run
